---
import { getCollection } from "astro:content";

import { Image } from "astro:assets";
// Setup navigation data
const allDocs = await getCollection("docs");
// Helper to build tree function omitted for brevity as it is unused in the previous snippet,
// using simple list as per previous placeholder. If recursive needed, can re-add.
// Focusing on UI request.

import logoBlack from "../assets/logo_square_black_alpha.webp";
import logoWhite from "../assets/logo_square_white_alpha.webp";
---

<header>
  <div class="header-content">
    <a href="/" class="logo">
      <div class="logo-wrapper">
        <Image
          src={logoBlack}
          alt="Logo"
          class="logo-img light-logo"
          loading="eager"
          fetchpriority="high"
        />
        <Image
          src={logoWhite}
          alt="Logo"
          class="logo-img dark-logo"
          loading="eager"
          fetchpriority="high"
        />
      </div>
      <span class="logo-text">TECH☆TECH</span>
    </a>

    <!-- Desktop Menu -->
    <nav class="desktop-menu">
      <ul>
        <li><a href="/">HOME</a></li>
        <li><a href="/about/whatistechtech">ABOUT</a></li>
        <li><a href="/blog">BLOG</a></li>
        <li><a href="/work">WORK</a></li>
      </ul>
    </nav>
    <div class="controls">
      <button id="theme-toggle" aria-label="Toggle Theme" class="theme-switch">
        <div class="switch-track">
          <div class="switch-thumb">
            <span class="icon-sun">☀</span>
            <span class="icon-moon">☾</span>
          </div>
        </div>
      </button>
      <button id="menu-toggle" aria-label="Toggle Menu" class="menu-btn">
        <span class="hamburger-icon">☰</span>
        <span class="close-icon">✕</span>
      </button>
    </div>
  </div>
  <nav id="nav-menu" class="nav-menu">
    <ul>
      <li><a href="/">HOME</a></li>
      <li><a href="/about/whatistechtech">ABOUT</a></li>
      <li><a href="/blog">BLOG</a></li>
      <li><a href="/work">WORK</a></li>
      <!-- Add more links as needed or generate dynamically -->
    </ul>
  </nav>
</header>

<style>
  header {
    background-color: var(--color-bg);
    border-bottom: 1px solid var(--color-border);
    padding: 1rem;
    position: sticky;
    top: 0;
    z-index: 100;
    transition:
      background-color 0.3s,
      border-color 0.3s;
  }
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
    z-index: 101; /* Above nav menu */
    background-color: var(--color-bg); /* Ensure opacity */
    transition: background-color 0.3s;
  }

  /* Logo Styles */
  .logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 700;
    font-size: 1.5rem;
    color: var(--color-text);
    text-decoration: none;
    transition: color 0.3s;
  }

  .logo-wrapper {
    position: relative;
    width: 40px;
    height: 40px;
  }

  .logo-img {
    height: 40px;
    width: auto;
    transition: opacity 0.3s;
    position: absolute;
    top: 0;
    left: 0;
  }

  /* Default state (Light Mode) */
  .logo-img.light-logo {
    opacity: 1;
    z-index: 2;
  }
  .logo-img.dark-logo {
    opacity: 0;
    z-index: 1;
  }

  /* Dark Mode Handlers */
  :global([data-theme="dark"]) .logo-img.light-logo {
    opacity: 0;
  }
  :global([data-theme="dark"]) .logo-img.dark-logo {
    opacity: 1;
  }

  /* Controls */
  .controls {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  /* Theme Toggle Switch */
  .theme-switch {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    width: 60px;
    height: 30px;
    position: relative;
  }
  .switch-track {
    background-color: var(--color-border);
    border-radius: 30px;
    width: 100%;
    height: 100%;
    position: relative;
    transition:
      background-color 0.3s,
      border-color 0.3s;
  }
  .switch-thumb {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 26px;
    height: 26px;
    background-color: var(--color-bg);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition:
      transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      background-color 0.3s;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  :global([data-theme="dark"]) .switch-thumb {
    transform: translateX(30px);
  }
  .icon-sun,
  .icon-moon {
    font-size: 0.8rem;
    position: absolute;
    transition: opacity 0.3s;
  }
  .icon-sun {
    opacity: 1;
    color: #f59e0b;
  }
  .icon-moon {
    opacity: 0;
    color: #6366f1;
  }

  :global([data-theme="dark"]) .icon-sun {
    opacity: 0;
  }
  :global([data-theme="dark"]) .icon-moon {
    opacity: 1;
  }

  /* Desktop Menu (Ribbon) */
  .desktop-menu {
    display: none;
  }
  .desktop-menu ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    gap: 2rem;
  }
  .desktop-menu a {
    text-decoration: none;
    color: var(--color-text);
    font-weight: 700;
    font-size: 1rem;
    transition: color 0.3s;
  }
  .desktop-menu a:hover {
    color: var(--color-primary);
  }

  /* Hamburger Menu Button */
  .menu-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.5rem;
    color: var(--color-text);
    padding: 0.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: color 0.3s;
  }
  .close-icon {
    display: none;
  }
  :global(body.menu-open) .hamburger-icon {
    display: none;
  }
  :global(body.menu-open) .close-icon {
    display: block;
  }

  /* Mobile Navigation Menu */
  .nav-menu {
    position: fixed; /* Cover entire viewport */
    top: 73px; /* Approximate header height. Adjust if needed or use JS */
    /* Note: Since header is sticky, top: 100% of header might allow content to be covered if using absolute. 
       Fixed is safer for overlay behavior but needs top offset matching header. 
       Let's stick to absolute relative to header if header is container? 
       No, let's use fixed Top: 0 and z-index below header to cover full screen. */
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 90; /* Below header (z-100) */

    visibility: hidden; /* Click-through when closed */
    transition: visibility 0.4s;
  }

  :global(body.menu-open) .nav-menu {
    visibility: visible;
  }

  /* Overlay (Backdrop) */
  .nav-menu::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--color-bg);
    opacity: 0;
    transition:
      opacity 0.4s ease,
      background-color 0.3s;
    margin-top: 73px;
  }

  :global(body.menu-open) .nav-menu::before {
    opacity: 0.7;
  }

  /* Mobile Nav Links Container (The sliding panel) */
  .nav-menu ul {
    position: relative; /* Above backdrop */
    list-style: none;
    padding: 2rem 6rem 2rem 2rem; /* Right padding larger as requested */
    margin: 0;
    margin-top: 73px;
    margin-left: auto; /* Align to right */
    text-align: left;

    width: fit-content;
    height: 100%; /* Full height */
    background-color: var(--color-bg); /* Solid background for menu */

    transform: translateX(100%); /* Start off-screen right */
    transition:
      transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
      background-color 0.3s;

    display: flex;
    flex-direction: column;
    /* Ensure content is scrollable if too tall, though normally minimal links */
    overflow-y: auto;

    /* Box shadow for depth */
    box-shadow: -1px 5px 10px rgba(0, 0, 0, 0.1);
  }

  :global(body.menu-open) .nav-menu ul {
    transform: translateX(0); /* Slide in */
  }

  .nav-menu li {
    margin: 0.8rem 0;
    opacity: 0;
    transform: translateX(20px); /* Slide slightly with list */
    transition:
      transform 0.3s ease,
      opacity 0.3s ease;
  }
  .nav-menu a {
    display: block;
    font-weight: 700;
    font-size: 1.4rem;
    color: var(--color-text);
    text-decoration: none;
    padding: 0.5rem 0;
    white-space: nowrap; /* Prevent wrapping */
    transition: color 0.3s;
  }

  /* Staggered animation for items */
  :global(body.menu-open) .nav-menu li {
    opacity: 1;
    transform: translateX(0);
  }
  :global(body.menu-open) .nav-menu li:nth-child(1) {
    transition-delay: 0.2s;
  }
  :global(body.menu-open) .nav-menu li:nth-child(2) {
    transition-delay: 0.25s;
  }
  :global(body.menu-open) .nav-menu li:nth-child(3) {
    transition-delay: 0.3s;
  }
  :global(body.menu-open) .nav-menu li:nth-child(4) {
    transition-delay: 0.35s;
  }

  /* Responsive Media Queries */
  @media (min-width: 768px) {
    .menu-btn {
      display: none; /* Hide hamburger on desktop */
    }
    .desktop-menu {
      display: block; /* Show ribbon menu on desktop */
      margin-left: auto;
    }
    .nav-menu {
      display: none; /* Ensure mobile menu is hidden on desktop */
    }
    /* Controls adjustment: Move theme toggle to right, keep desktop menu in middle or right */
    .header-content {
      justify-content: flex-start;
      gap: 2rem;
    }
    .controls {
      margin-left: 0;
    }
  }

  @media (max-width: 767px) {
    .header-content {
      justify-content: space-between;
    }
  }
</style>

<script>
  const themeToggle = document.getElementById("theme-toggle");
  const menuToggle = document.getElementById("menu-toggle");

  // Theme Toggle
  themeToggle?.addEventListener("click", () => {
    const currentTheme = document.documentElement.getAttribute("data-theme");
    const newTheme = currentTheme === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", newTheme);
    localStorage.setItem("theme", newTheme);
  });

  // Menu Toggle (Click only)
  menuToggle?.addEventListener("click", () => {
    document.body.classList.toggle("menu-open");
  });

  // Close menu when clicking backdrop
  const navMenu = document.getElementById("nav-menu");
  navMenu?.addEventListener("click", (e) => {
    // Check if the click was on the nav-menu itself (backdrop) or specifically NOT the ul
    // Since ul stops propagation usually or we check target
    // In this CSS structure, .nav-menu is the full screen container.
    // The ul is the child.
    if (e.target === navMenu) {
      document.body.classList.remove("menu-open");
    }
  });
</script>
